# 激活码管理页面功能优化

## 问题分析

1. **获取已过期激活码数据始终为空**：当前代码中，获取过期激活码的逻辑是`and(eq(activationCodes.isUsed, false), lt(activationCodes.expiresAt, now))`，这意味着只有未使用且过期的激活码才会被统计为过期。但实际上，已使用的激活码如果过期了，也应该被视为过期激活码。

2. **缺少已过期激活码数据的显示卡片**：激活码管理页面目前没有专门展示已过期激活码数量的卡片。

3. **缺少删除已过期激活码的功能**：系统目前没有提供删除已过期激活码的功能。

## 解决方案

### 1. 修复获取已过期激活码的逻辑

- **修改 `app/api/activation-codes/route.ts`**：将获取激活码列表时"expired"状态的条件修改为只检查`lt(activationCodes.expiresAt, now)`，不考虑`isUsed`状态。

- **修改 `app/api/activation-codes/stats/route.ts`**：将获取过期激活码数量的逻辑修改为只检查`lt(activationCodes.expiresAt, now)`，不考虑`isUsed`状态。

### 2. 新增删除已过期激活码的功能

- **新增 `app/api/activation-codes/cleanup-expired/route.ts`**：创建一个新的API端点，用于删除所有已过期的激活码。

- **修改 `utils/activation-codes-api.ts`**：添加删除已过期激活码的方法。

### 3. 优化激活码管理页面

- **修改 `app/admin/activation-codes/page.tsx`**：
  - 添加已过期激活码数据的显示卡片，展示已过期激活码的数量。
  - 添加删除已过期激活码的功能按钮，调用新增的API端点。
  - 确保删除操作后不影响总激活码的计数统计。

## 实施步骤

1. **修复获取已过期激活码的逻辑**：
   - 修改 `app/api/activation-codes/route.ts` 中的状态条件判断
   - 修改 `app/api/activation-codes/stats/route.ts` 中的统计逻辑

2. **新增删除已过期激活码的API端点**：
   - 创建 `app/api/activation-codes/cleanup-expired/route.ts` 文件
   - 实现删除已过期激活码的逻辑

3. **更新激活码API工具类**：
   - 修改 `utils/activation-codes-api.ts`，添加删除已过期激活码的方法

4. **优化激活码管理页面**：
   - 添加已过期激活码数据的显示卡片
   - 添加删除已过期激活码的功能按钮
   - 实现删除已过期激活码的交互逻辑

5. **测试验证**：
   - 测试获取已过期激活码的功能
   - 测试删除已过期激活码的功能
   - 测试总激活码计数统计是否正常

## 预期效果

- 激活码管理页面将显示已过期激活码的数量
- 用户可以通过按钮删除已过期的激活码
- 删除已过期激活码后，总激活码计数统计将正确更新
- 已过期激活码数据将准确显示，不再为空

## 注意事项

- 在删除已过期激活码时，需要确保只删除真正过期的激活码
- 删除操作需要添加确认提示，防止误操作
- 删除操作后需要刷新页面数据，确保用户看到最新的统计信息
- 所有API端点都需要添加适当的认证和授权检查

<|end_of_plan|>